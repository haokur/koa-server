import{A as x,a as P}from"./AsyncQueue-DG5LUosy.js";import{h as C,d as R,o as V,c as k,a as g,i as q,j as O,F as z,r as A,k as T,e as m,_ as B,l as Q,m as E,n as N,p as L,w as F,t as I,b as M,f as K,g as $,q as Y,s as G}from"./index-HO1tAa6s.js";function H(c,r){return Math.floor(Math.random()*(r-c+1)+c)}function J(c){const r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".split("");let d="";const e=r.length;for(let n=0;n<c;n+=1)d+=r[H(0,e)];return d}var D={title:"生产环境",baseUrl:"http://localhost:3000"};function W(c){const r=C(0),d=C(""),e=.4*1024*1024,n={chunkSize:e,file:null,fileName:"",totalChunk:0,finishedChunk:0,chunkPercentage:0,chunkStatus:[],remoteFileUrl:""};async function _(i){const h=v(i),{fileName:a,totalChunk:o}=n,l=new FormData;l.append("file",h);const t=`${D.baseUrl}/file/upload?fileName=${a}&currentChunkIndex=${i}&totalChunkNum=${o}`;await P.post(t,l).then(s=>{n.finishedChunk+=1;const u=n.finishedChunk/n.totalChunk*100;if(n.chunkPercentage=Math.floor(u),n.chunkStatus[i].status=2,r.value=n.finishedChunk/n.totalChunk,s.data.msg==="finished"){const y=`${D.baseUrl}/file/upload-result?fileName=${a}`;d.value=y,n.remoteFileUrl=y,console.log(y,d.value,"upload.hook.ts::62行")}})}const v=i=>{const h=n.file,a=i*e,o=Math.min(a+e,h.size);return h.slice(a,o)},f=new x(c,!0),p=async i=>{await _(i.index)};return{progress:r,remoteUrl:d,initUpload:(i,h)=>{const a=Math.ceil(i.size/e),o=Array.from({length:a},(l,t)=>({index:t,start:t*e,end:(t+1)*e,status:0}));Object.assign(n,{file:i,totalChunk:a,fileName:i.name,finishedChunk:0,chunkPercentage:0,chunkStatus:o,remoteFileUrl:""}),f.finishCallback=h,f.clear(),f.addManyTask(n.chunkStatus,p)},startUpload:()=>{f.run()},pauseUpload:()=>{f.pause()}}}const X={class:"upload-wrap"},Z=["id","disabled"],ee=["for"],te={class:"img-list"},ne=["src"],ae=R({__name:"UploadControl",props:{imgList:{type:Array,default(){return[]}},bizId:{type:String,default:""}},emits:["success","update:imgList"],setup(c,{expose:r,emit:d}){const e=c,n=C(!1),_=C("");V(()=>{_.value="cpt_"+J(8)});const v=C();function f(){v.value.click()}r({chooseFile:f});function p(t){if(n.value)return;n.value=!0;let s=Array.from(t.target.files);S(s)}const U=d;function S(t){Promise.all(t.map(s=>l(s))).then(s=>{U("update:imgList",s),U("success",s),n.value=!1,console.log("全部列表回调",s,e.imgList,"UploadControl.vue::65行")}).catch(s=>{console.log(s,"MultiUpload.vue::23行")})}const{progress:w,remoteUrl:i,initUpload:h,startUpload:a,pauseUpload:o}=W(2);function l(t){return new Promise(s=>{h(t,()=>{s({imgUrl:i.value,originName:t.name})}),a()})}return(t,s)=>{const u=T("loading");return m(),k("div",X,[g("input",{class:"input",id:_.value,type:"file",multiple:"",disabled:n.value,onChange:p},null,40,Z),q((m(),k("label",{for:_.value,class:"img-label",ref_key:"multiUploadLabelRef",ref:v},[O(t.$slots,"default",{},void 0,!0)],8,ee)),[[u,n.value]]),g("div",te,[(m(!0),k(z,null,A(c.imgList,(y,j)=>(m(),k("div",{class:"img-item",key:j},[g("img",{src:y.imgUrl,class:"img"},null,8,ne)]))),128))])])}}}),se=B(ae,[["__scopeId","data-v-a88130c9"]]),oe=c=>(Y("data-v-a67fcdc8"),c=c(),G(),c),le={class:"upload"},ie={key:0,class:"demo-progress"},ce={class:"steps"},ue={key:1,class:"upload-all"},re=["src"],de=oe(()=>g("h3",null,"上传组件",-1)),b=.4*1024*1024,pe=2,he=R({__name:"upload",setup(c){const r=C(null),d=C([]),e=Q({chunkSize:b,file:null,fileName:"",totalChunk:0,finishedChunk:0,chunkPercentage:0,chunkStatus:[],remoteFileUrl:""}),n=E(()=>!!e.totalChunk),_=a=>{const o=a.target.files[0];let l=Math.ceil(o.size/b),t=Array.from({length:l},(s,u)=>({index:u,start:u*b,end:(u+1)*b,status:0}));Object.assign(e,{file:o,totalChunk:l,fileName:o.name,finishedChunk:0,chunkPercentage:0,chunkStatus:t,remoteFileUrl:""})};async function v(a){const o=f(a);let{fileName:l,totalChunk:t}=e;const s=new FormData;s.append("file",o),await P.post(`http://localhost:3000/file/upload?fileName=${l}&currentChunkIndex=${a}&totalChunkNum=${t}`,s).then(u=>{e.finishedChunk+=1,e.chunkPercentage=Math.floor(e.finishedChunk/e.totalChunk*100),e.chunkStatus[a].status=2,u.data.msg==="finished"&&(e.remoteFileUrl=`http://localhost:3000/file/upload-result?fileName=${l}`)})}const f=a=>{const o=r.value.files[0],l=a*b,t=Math.min(l+b,o.size);return o.slice(l,t)},p=new x(pe,!0),U=async a=>{await v(a.index)},S=async a=>{p.addTask(e.chunkStatus[a],U),p.run()};async function w(){p.addManyTask(e.chunkStatus,U),p.run()}const i=()=>{p.pause()},h=()=>{p.run()};return(a,o)=>{const l=M("el-progress"),t=M("el-button");return m(),k("div",le,[g("input",{type:"file",onChange:_,ref_key:"inputRef",ref:r},null,544),n.value?(m(),k("div",ie,[N(l,{percentage:e.chunkPercentage},null,8,["percentage"])])):L("",!0),g("div",ce,[(m(!0),k(z,null,A(e.totalChunk,(s,u)=>(m(),K(t,{key:u,type:"primary",onClick:y=>S(u)},{default:F(()=>[$(" 上传片段"+I(u+1),1)]),_:2},1032,["onClick"]))),128))]),n.value?(m(),k("div",ue,[N(t,{type:"primary",onClick:w},{default:F(()=>[$("全部片段上传")]),_:1}),N(t,{type:"primary",onClick:i},{default:F(()=>[$("中断上传")]),_:1}),N(t,{type:"primary",onClick:h},{default:F(()=>[$("继续上传")]),_:1})])):L("",!0),e.remoteFileUrl?(m(),k("img",{key:2,class:"img",src:e.remoteFileUrl},null,8,re)):L("",!0),g("div",null,I(e),1),g("div",null,[de,N(se,{imgList:d.value,"onUpdate:imgList":o[0]||(o[0]=s=>d.value=s)},null,8,["imgList"])])])}}}),ke=B(he,[["__scopeId","data-v-a67fcdc8"]]);export{ke as default};
