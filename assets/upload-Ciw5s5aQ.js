var K=Object.defineProperty;var Y=(h,a,i)=>a in h?K(h,a,{enumerable:!0,configurable:!0,writable:!0,value:i}):h[a]=i;var I=(h,a,i)=>Y(h,typeof a!="symbol"?a+"":a,i);import{A as k,a as R}from"./axios-b2ErKn4C.js";import{h as G,d as Q,i as C,j as H,o as J,c as N,a as U,k as W,F as X,r as Z,b as L,l as ee,e as F,m as te,f as ne,n as M,_ as P,p as x,u as j,w as O,g as z,q as re,s as se}from"./index-3YMnPb4w.js";function oe(h,a){return Math.floor(Math.random()*(a-h+1)+h)}function ae(h){const a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".split("");let i="";const c=a.length;for(let u=0;u<h;u+=1)i+=a[oe(0,c)];return i}var q={exports:{}};(function(h,a){(function(i){h.exports=i()})(function(i){var c=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function u(o,s){var t=o[0],e=o[1],r=o[2],n=o[3];t+=(e&r|~e&n)+s[0]-680876936|0,t=(t<<7|t>>>25)+e|0,n+=(t&e|~t&r)+s[1]-389564586|0,n=(n<<12|n>>>20)+t|0,r+=(n&t|~n&e)+s[2]+606105819|0,r=(r<<17|r>>>15)+n|0,e+=(r&n|~r&t)+s[3]-1044525330|0,e=(e<<22|e>>>10)+r|0,t+=(e&r|~e&n)+s[4]-176418897|0,t=(t<<7|t>>>25)+e|0,n+=(t&e|~t&r)+s[5]+1200080426|0,n=(n<<12|n>>>20)+t|0,r+=(n&t|~n&e)+s[6]-1473231341|0,r=(r<<17|r>>>15)+n|0,e+=(r&n|~r&t)+s[7]-45705983|0,e=(e<<22|e>>>10)+r|0,t+=(e&r|~e&n)+s[8]+1770035416|0,t=(t<<7|t>>>25)+e|0,n+=(t&e|~t&r)+s[9]-1958414417|0,n=(n<<12|n>>>20)+t|0,r+=(n&t|~n&e)+s[10]-42063|0,r=(r<<17|r>>>15)+n|0,e+=(r&n|~r&t)+s[11]-1990404162|0,e=(e<<22|e>>>10)+r|0,t+=(e&r|~e&n)+s[12]+1804603682|0,t=(t<<7|t>>>25)+e|0,n+=(t&e|~t&r)+s[13]-40341101|0,n=(n<<12|n>>>20)+t|0,r+=(n&t|~n&e)+s[14]-1502002290|0,r=(r<<17|r>>>15)+n|0,e+=(r&n|~r&t)+s[15]+1236535329|0,e=(e<<22|e>>>10)+r|0,t+=(e&n|r&~n)+s[1]-165796510|0,t=(t<<5|t>>>27)+e|0,n+=(t&r|e&~r)+s[6]-1069501632|0,n=(n<<9|n>>>23)+t|0,r+=(n&e|t&~e)+s[11]+643717713|0,r=(r<<14|r>>>18)+n|0,e+=(r&t|n&~t)+s[0]-373897302|0,e=(e<<20|e>>>12)+r|0,t+=(e&n|r&~n)+s[5]-701558691|0,t=(t<<5|t>>>27)+e|0,n+=(t&r|e&~r)+s[10]+38016083|0,n=(n<<9|n>>>23)+t|0,r+=(n&e|t&~e)+s[15]-660478335|0,r=(r<<14|r>>>18)+n|0,e+=(r&t|n&~t)+s[4]-405537848|0,e=(e<<20|e>>>12)+r|0,t+=(e&n|r&~n)+s[9]+568446438|0,t=(t<<5|t>>>27)+e|0,n+=(t&r|e&~r)+s[14]-1019803690|0,n=(n<<9|n>>>23)+t|0,r+=(n&e|t&~e)+s[3]-187363961|0,r=(r<<14|r>>>18)+n|0,e+=(r&t|n&~t)+s[8]+1163531501|0,e=(e<<20|e>>>12)+r|0,t+=(e&n|r&~n)+s[13]-1444681467|0,t=(t<<5|t>>>27)+e|0,n+=(t&r|e&~r)+s[2]-51403784|0,n=(n<<9|n>>>23)+t|0,r+=(n&e|t&~e)+s[7]+1735328473|0,r=(r<<14|r>>>18)+n|0,e+=(r&t|n&~t)+s[12]-1926607734|0,e=(e<<20|e>>>12)+r|0,t+=(e^r^n)+s[5]-378558|0,t=(t<<4|t>>>28)+e|0,n+=(t^e^r)+s[8]-2022574463|0,n=(n<<11|n>>>21)+t|0,r+=(n^t^e)+s[11]+1839030562|0,r=(r<<16|r>>>16)+n|0,e+=(r^n^t)+s[14]-35309556|0,e=(e<<23|e>>>9)+r|0,t+=(e^r^n)+s[1]-1530992060|0,t=(t<<4|t>>>28)+e|0,n+=(t^e^r)+s[4]+1272893353|0,n=(n<<11|n>>>21)+t|0,r+=(n^t^e)+s[7]-155497632|0,r=(r<<16|r>>>16)+n|0,e+=(r^n^t)+s[10]-1094730640|0,e=(e<<23|e>>>9)+r|0,t+=(e^r^n)+s[13]+681279174|0,t=(t<<4|t>>>28)+e|0,n+=(t^e^r)+s[0]-358537222|0,n=(n<<11|n>>>21)+t|0,r+=(n^t^e)+s[3]-722521979|0,r=(r<<16|r>>>16)+n|0,e+=(r^n^t)+s[6]+76029189|0,e=(e<<23|e>>>9)+r|0,t+=(e^r^n)+s[9]-640364487|0,t=(t<<4|t>>>28)+e|0,n+=(t^e^r)+s[12]-421815835|0,n=(n<<11|n>>>21)+t|0,r+=(n^t^e)+s[15]+530742520|0,r=(r<<16|r>>>16)+n|0,e+=(r^n^t)+s[2]-995338651|0,e=(e<<23|e>>>9)+r|0,t+=(r^(e|~n))+s[0]-198630844|0,t=(t<<6|t>>>26)+e|0,n+=(e^(t|~r))+s[7]+1126891415|0,n=(n<<10|n>>>22)+t|0,r+=(t^(n|~e))+s[14]-1416354905|0,r=(r<<15|r>>>17)+n|0,e+=(n^(r|~t))+s[5]-57434055|0,e=(e<<21|e>>>11)+r|0,t+=(r^(e|~n))+s[12]+1700485571|0,t=(t<<6|t>>>26)+e|0,n+=(e^(t|~r))+s[3]-1894986606|0,n=(n<<10|n>>>22)+t|0,r+=(t^(n|~e))+s[10]-1051523|0,r=(r<<15|r>>>17)+n|0,e+=(n^(r|~t))+s[1]-2054922799|0,e=(e<<21|e>>>11)+r|0,t+=(r^(e|~n))+s[8]+1873313359|0,t=(t<<6|t>>>26)+e|0,n+=(e^(t|~r))+s[15]-30611744|0,n=(n<<10|n>>>22)+t|0,r+=(t^(n|~e))+s[6]-1560198380|0,r=(r<<15|r>>>17)+n|0,e+=(n^(r|~t))+s[13]+1309151649|0,e=(e<<21|e>>>11)+r|0,t+=(r^(e|~n))+s[4]-145523070|0,t=(t<<6|t>>>26)+e|0,n+=(e^(t|~r))+s[11]-1120210379|0,n=(n<<10|n>>>22)+t|0,r+=(t^(n|~e))+s[2]+718787259|0,r=(r<<15|r>>>17)+n|0,e+=(n^(r|~t))+s[9]-343485551|0,e=(e<<21|e>>>11)+r|0,o[0]=t+o[0]|0,o[1]=e+o[1]|0,o[2]=r+o[2]|0,o[3]=n+o[3]|0}function f(o){var s=[],t;for(t=0;t<64;t+=4)s[t>>2]=o.charCodeAt(t)+(o.charCodeAt(t+1)<<8)+(o.charCodeAt(t+2)<<16)+(o.charCodeAt(t+3)<<24);return s}function p(o){var s=[],t;for(t=0;t<64;t+=4)s[t>>2]=o[t]+(o[t+1]<<8)+(o[t+2]<<16)+(o[t+3]<<24);return s}function g(o){var s=o.length,t=[1732584193,-271733879,-1732584194,271733878],e,r,n,b,A,w;for(e=64;e<=s;e+=64)u(t,f(o.substring(e-64,e)));for(o=o.substring(e-64),r=o.length,n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e=0;e<r;e+=1)n[e>>2]|=o.charCodeAt(e)<<(e%4<<3);if(n[e>>2]|=128<<(e%4<<3),e>55)for(u(t,n),e=0;e<16;e+=1)n[e]=0;return b=s*8,b=b.toString(16).match(/(.*?)(.{0,8})$/),A=parseInt(b[2],16),w=parseInt(b[1],16)||0,n[14]=A,n[15]=w,u(t,n),t}function d(o){var s=o.length,t=[1732584193,-271733879,-1732584194,271733878],e,r,n,b,A,w;for(e=64;e<=s;e+=64)u(t,p(o.subarray(e-64,e)));for(o=e-64<s?o.subarray(e-64):new Uint8Array(0),r=o.length,n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e=0;e<r;e+=1)n[e>>2]|=o[e]<<(e%4<<3);if(n[e>>2]|=128<<(e%4<<3),e>55)for(u(t,n),e=0;e<16;e+=1)n[e]=0;return b=s*8,b=b.toString(16).match(/(.*?)(.{0,8})$/),A=parseInt(b[2],16),w=parseInt(b[1],16)||0,n[14]=A,n[15]=w,u(t,n),t}function y(o){var s="",t;for(t=0;t<4;t+=1)s+=c[o>>t*8+4&15]+c[o>>t*8&15];return s}function m(o){var s;for(s=0;s<o.length;s+=1)o[s]=y(o[s]);return o.join("")}m(g("hello")),typeof ArrayBuffer<"u"&&!ArrayBuffer.prototype.slice&&function(){function o(s,t){return s=s|0||0,s<0?Math.max(s+t,0):Math.min(s,t)}ArrayBuffer.prototype.slice=function(s,t){var e=this.byteLength,r=o(s,e),n=e,b,A,w,D;return t!==i&&(n=o(t,e)),r>n?new ArrayBuffer(0):(b=n-r,A=new ArrayBuffer(b),w=new Uint8Array(A),D=new Uint8Array(this,r,b),w.set(D),A)}}();function S(o){return/[\u0080-\uFFFF]/.test(o)&&(o=unescape(encodeURIComponent(o))),o}function v(o,s){var t=o.length,e=new ArrayBuffer(t),r=new Uint8Array(e),n;for(n=0;n<t;n+=1)r[n]=o.charCodeAt(n);return s?r:e}function $(o){return String.fromCharCode.apply(null,new Uint8Array(o))}function B(o,s,t){var e=new Uint8Array(o.byteLength+s.byteLength);return e.set(new Uint8Array(o)),e.set(new Uint8Array(s),o.byteLength),e}function _(o){var s=[],t=o.length,e;for(e=0;e<t-1;e+=2)s.push(parseInt(o.substr(e,2),16));return String.fromCharCode.apply(String,s)}function l(){this.reset()}return l.prototype.append=function(o){return this.appendBinary(S(o)),this},l.prototype.appendBinary=function(o){this._buff+=o,this._length+=o.length;var s=this._buff.length,t;for(t=64;t<=s;t+=64)u(this._hash,f(this._buff.substring(t-64,t)));return this._buff=this._buff.substring(t-64),this},l.prototype.end=function(o){var s=this._buff,t=s.length,e,r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],n;for(e=0;e<t;e+=1)r[e>>2]|=s.charCodeAt(e)<<(e%4<<3);return this._finish(r,t),n=m(this._hash),o&&(n=_(n)),this.reset(),n},l.prototype.reset=function(){return this._buff="",this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},l.prototype.getState=function(){return{buff:this._buff,length:this._length,hash:this._hash.slice()}},l.prototype.setState=function(o){return this._buff=o.buff,this._length=o.length,this._hash=o.hash,this},l.prototype.destroy=function(){delete this._hash,delete this._buff,delete this._length},l.prototype._finish=function(o,s){var t=s,e,r,n;if(o[t>>2]|=128<<(t%4<<3),t>55)for(u(this._hash,o),t=0;t<16;t+=1)o[t]=0;e=this._length*8,e=e.toString(16).match(/(.*?)(.{0,8})$/),r=parseInt(e[2],16),n=parseInt(e[1],16)||0,o[14]=r,o[15]=n,u(this._hash,o)},l.hash=function(o,s){return l.hashBinary(S(o),s)},l.hashBinary=function(o,s){var t=g(o),e=m(t);return s?_(e):e},l.ArrayBuffer=function(){this.reset()},l.ArrayBuffer.prototype.append=function(o){var s=B(this._buff.buffer,o),t=s.length,e;for(this._length+=o.byteLength,e=64;e<=t;e+=64)u(this._hash,p(s.subarray(e-64,e)));return this._buff=e-64<t?new Uint8Array(s.buffer.slice(e-64)):new Uint8Array(0),this},l.ArrayBuffer.prototype.end=function(o){var s=this._buff,t=s.length,e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],r,n;for(r=0;r<t;r+=1)e[r>>2]|=s[r]<<(r%4<<3);return this._finish(e,t),n=m(this._hash),o&&(n=_(n)),this.reset(),n},l.ArrayBuffer.prototype.reset=function(){return this._buff=new Uint8Array(0),this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},l.ArrayBuffer.prototype.getState=function(){var o=l.prototype.getState.call(this);return o.buff=$(o.buff),o},l.ArrayBuffer.prototype.setState=function(o){return o.buff=v(o.buff,!0),l.prototype.setState.call(this,o)},l.ArrayBuffer.prototype.destroy=l.prototype.destroy,l.ArrayBuffer.prototype._finish=l.prototype._finish,l.ArrayBuffer.hash=function(o,s){var t=d(new Uint8Array(o)),e=m(t);return s?_(e):e},l})})(q);var ie=q.exports;const ue=G(ie);function le(h){return new Promise((a,i)=>{const c=new FileReader;c.onload=function(u){var d;const f=new ue.ArrayBuffer,p=(d=u.target)==null?void 0:d.result;f.append(p);const g=f.end();a(g)},c.onerror=function(u){i(u)},c.readAsArrayBuffer(h)})}function ce(h){return h.split(".").pop()||""}var V={title:"生产环境",baseUrl:"https://api.haokur.com"};const he=.4*1024*1024,fe=2;class T{constructor(a,i,c,u){I(this,"currentUploadObj",{chunkSize:1024,file:null,fileName:"",fileExt:"",totalChunk:0,finishedChunk:0,chunkPercentage:0,chunkStatus:[],remoteFileUrl:""});I(this,"splitChunkSize");I(this,"uploader");I(this,"concurrentMax");I(this,"chunkUploadQueue");this.currentUploadObj.file=a,this.currentUploadObj.fileName=a.name,this.currentUploadObj.fileExt=ce(a.name),this.splitChunkSize=c||he,this.currentUploadObj.chunkSize=this.splitChunkSize,this.uploader=u||this._defaultUploader,this.concurrentMax=i||fe,this.chunkUploadQueue=new k(this.concurrentMax)}async _defaultUploader(a){const i=this.currentUploadObj,c=this.getRangeBufferByIndex(a),{fileName:u,fileExt:f,totalChunk:p,md5Value:g}=i,d=new FormData;d.append("file",c);let y=`${V.baseUrl}/file/upload?fileName=${u}&currentChunkIndex=${a}&totalChunkNum=${p}`;g&&(y+=`&md5=${g}&ext=${f}`),await R.post(y,d).then(()=>{i.finishedChunk+=1;let m=i.finishedChunk/i.totalChunk*100;m=Math.floor(m),i.chunkPercentage=m,i.chunkStatus[a].status=2})}getRangeBufferByIndex(a){const i=this.currentUploadObj.file,c=a*this.splitChunkSize,u=Math.min(c+this.splitChunkSize,i.size);return i.slice(c,u)}splitFile2Chunks(){const a=this.currentUploadObj.file,i=this.splitChunkSize,c=Math.ceil(a.size/i);console.log(a.size,i,c,"FileUploader.ts::101行");const u=Array.from({length:c},(f,p)=>({index:p,start:p*i,end:(p+1)*i,status:0}));return Object.assign(this.currentUploadObj,{file:a,totalChunk:c,fileName:a.name,finishedChunk:0,chunkPercentage:0,chunkStatus:u,remoteFileUrl:""}),u}async isFileExist(){const a=await le(this.currentUploadObj.file);this.currentUploadObj.md5Value=a;const c=(await R.head(`${V.baseUrl}/file/exist?md5=${a}&ext=${this.currentUploadObj.fileExt}`)).headers["content-length"]||"0";return parseInt(c)>0}async enqueue(a,i){const c=await this.isFileExist();if(console.log("是否存在",c,"FileUploader.ts::136行"),this.chunkUploadQueue.finishCallback=()=>{console.log("执行队列完成的回调finishCallback","FileUploader.ts::139行");const{md5Value:f,fileName:p,fileExt:g}=this.currentUploadObj,d=f?`${f}.${g}`:p,y=`${V.baseUrl}/file/upload-result?fileName=${d}`;this.currentUploadObj.remoteFileUrl=y,i&&i(this.currentUploadObj)},c)return;const u=this.splitFile2Chunks();console.log("切割开的块",u,"FileUploader.ts::150行"),this.chunkUploadQueue.addManyTask(u,async f=>{const{index:p}=f;await this.uploader(p),a&&a(this.currentUploadObj)})}pause(){this.chunkUploadQueue.pause()}async start(){this.chunkUploadQueue.run()}}const pe={class:"upload-wrap"},de=["id","disabled"],me=["for"],ge={class:"progress-loading"},ye={class:"progress-mask"},_e={class:"progress-content"},be={class:"img-list"},Ue=["src"],ve=Q({__name:"UploadControl",props:{imgList:{type:Array,default(){return[]}},concurrentFileNum:{type:Number,default:2},fileConcurrentChunkNum:{type:Number,default:2},bizId:{type:String,default:""}},emits:["success","update:imgList"],setup(h,{expose:a,emit:i}){const c=h,u=C(!1),f=C([]),p=C([]),g=H(()=>p.value.length?Math.floor(f.value.length/p.value.length*100):0),d=C("");J(()=>{d.value="cpt_"+ae(8)});const y=C();function m(){y.value.click()}a({chooseFile:m});function S(_){if(u.value)return;u.value=!0;const l=_.target.files;if(!l)return;const o=Array.from(l);B(o)}async function v(_){return new Promise(async l=>{const o=new T(_,c.fileConcurrentChunkNum);await o.enqueue(null,s=>{let t={imgUrl:s.remoteFileUrl};console.log("成功回调","UploadControl.vue::92行"),l(t)}),console.log("单个文件添加队列完成","UploadControl.vue::94行"),o.start()})}const $=i;function B(_){p.value=_;const l=new k(c.fileConcurrentChunkNum);l.addManyTask(_,async o=>{const s=await v(o);$("update:imgList",[...c.imgList,s]),$("success",s),f.value.push("")}),l.finishCallback=()=>{setTimeout(()=>{u.value=!1,f.value=[],p.value=[]},2e3)},l.run()}return(_,l)=>{const o=L("el-progress"),s=ee("loading");return F(),N("div",pe,[U("input",{class:"input",id:d.value,type:"file",multiple:"",disabled:u.value,onChange:S},null,40,de),U("label",{for:d.value,class:"img-label",ref_key:"multiUploadLabelRef",ref:y},[W(_.$slots,"default",{},()=>[U("div",ge,[te(U("div",ye,null,512),[[s,u.value]]),U("div",_e,[g.value?(F(),ne(o,{key:0,type:"circle",width:60,status:`${g.value===100?"success":""}`,percentage:g.value},null,8,["status","percentage"])):M("",!0)])])],!0)],8,me),U("div",be,[(F(!0),N(X,null,Z(h.imgList,(t,e)=>(F(),N("div",{class:"img-item",key:e},[U("img",{src:t.imgUrl,class:"img"},null,8,Ue)]))),128))])])}}}),Ce=P(ve,[["__scopeId","data-v-cacdf413"]]);function Ae(h=4,a=.4*1024*1024){const i=C(0),c=C("");let u;return{progress:i,remoteUrl:c,initUpload:async(d,y)=>{u=new T(d,h,a),await u.enqueue(m=>{i.value=m.chunkPercentage},m=>{c.value=m.remoteFileUrl,y&&y()})},startUpload:()=>{u.start()},pauseUpload:()=>{u.pause()}}}const E=h=>(re("data-v-fea1ad3a"),h=h(),se(),h),we={class:"upload"},Fe={key:0,class:"demo-progress"},Se={key:1,class:"upload-all"},Be=["src"],xe=E(()=>U("h3",null,"上传组件",-1)),Ne={class:"mb20"},$e=E(()=>U("label",{class:"mr16"},"同时上传文件数量",-1)),Ie={class:"mb20"},je=E(()=>U("label",{class:"mr16"},"单文件切片数量",-1)),Le=2,Me=.4*1024*1024,Oe=Q({__name:"upload",setup(h){const a=C([]);C("");const i=C(3),c=C(4),{progress:u,remoteUrl:f,initUpload:p,pauseUpload:g,startUpload:d}=Ae(Le,Me),y=C(!1),m=S=>{y.value=!0,p(S.target.files[0],v=>{console.log(v,"upload.vue::73行")})};return(S,v)=>{const $=L("el-progress"),B=L("el-button"),_=L("el-input-number");return F(),N("div",we,[U("input",{type:"file",onChange:m},null,32),y.value?(F(),N("div",Fe,[x($,{percentage:j(u)},null,8,["percentage"])])):M("",!0),y.value?(F(),N("div",Se,[x(B,{type:"primary",onClick:j(d)},{default:O(()=>[z("全部片段上传")]),_:1},8,["onClick"]),x(B,{type:"primary",onClick:j(g)},{default:O(()=>[z("中断上传")]),_:1},8,["onClick"]),x(B,{type:"primary",onClick:j(d)},{default:O(()=>[z("继续上传")]),_:1},8,["onClick"])])):M("",!0),j(f)?(F(),N("img",{key:2,class:"img",src:j(f)},null,8,Be)):M("",!0),U("div",null,[xe,U("div",Ne,[$e,x(_,{modelValue:i.value,"onUpdate:modelValue":v[0]||(v[0]=l=>i.value=l),min:1,max:8},null,8,["modelValue"])]),U("div",Ie,[je,x(_,{modelValue:c.value,"onUpdate:modelValue":v[1]||(v[1]=l=>c.value=l),min:1,max:8},null,8,["modelValue"])]),x(Ce,{imgList:a.value,"onUpdate:imgList":v[2]||(v[2]=l=>a.value=l),concurrentFileNum:i.value,fileConcurrentChunkNum:c.value},null,8,["imgList","concurrentFileNum","fileConcurrentChunkNum"])])])}}}),De=P(Oe,[["__scopeId","data-v-fea1ad3a"]]);export{De as default};
//# sourceMappingURL=upload-Ciw5s5aQ.js.map
