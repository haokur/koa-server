var D=Object.defineProperty;var Q=(a,e,t)=>e in a?D(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var C=(a,e,t)=>Q(a,typeof e!="symbol"?e+"":e,t);import{d as L,g as d,h as R,i as q,j as P,c as U,a as r,k as T,F as A,r as G,b as N,l as H,o as g,m as J,e as K,n as $,_ as M,p as k,u as b,w as S,f as j,q as W,s as X}from"./index-CmaLx7AV.js";import{a as z}from"./axios-B4uVmeYG.js";import{g as Y,a as Z}from"./file.util-Cikv57d-.js";import{M as I}from"./MultiChannel-CkJFUiEV.js";var O={NODE_ENV:"production",title:"生产环境",baseUrl:"https://api.haokur.com",workerBaseUrl:"workers"};const ee=.4*1024*1024,te=2;class E{constructor(e,t,s,n){C(this,"currentUploadObj",{chunkSize:1024,file:null,fileName:"",fileExt:"",totalChunk:0,finishedChunk:0,chunkPercentage:0,chunkStatus:[],remoteFileUrl:""});C(this,"splitChunkSize");C(this,"uploader");C(this,"concurrentMax");C(this,"chunkUploadQueue");this.currentUploadObj.file=e,this.currentUploadObj.fileName=e.name,this.currentUploadObj.fileExt=Y(e.name),this.splitChunkSize=s||ee,this.currentUploadObj.chunkSize=this.splitChunkSize,this.uploader=n||this._defaultUploader,this.concurrentMax=t||te,this.chunkUploadQueue=new I(this.concurrentMax)}async _defaultUploader(e){const t=this.currentUploadObj,s=this.getRangeBufferByIndex(e),{fileName:n,fileExt:o,totalChunk:l,md5Value:p}=t,c=new FormData;c.append("file",s);let i=`${O.baseUrl}/file/upload?fileName=${n}&currentChunkIndex=${e}&totalChunkNum=${l}`;p&&(i+=`&md5=${p}&ext=${o}`),await z.post(i,c).then(()=>{t.finishedChunk+=1;let h=t.finishedChunk/t.totalChunk*100;h=Math.floor(h),t.chunkPercentage=h,t.chunkStatus[e].status=2})}getRangeBufferByIndex(e){const t=this.currentUploadObj.file,s=e*this.splitChunkSize,n=Math.min(s+this.splitChunkSize,t.size);return t.slice(s,n)}splitFile2Chunks(){const e=this.currentUploadObj.file,t=this.splitChunkSize,s=Math.ceil(e.size/t),n=Array.from({length:s},(o,l)=>({index:l,start:l*t,end:(l+1)*t,status:0}));return Object.assign(this.currentUploadObj,{file:e,totalChunk:s,fileName:e.name,finishedChunk:0,chunkPercentage:0,chunkStatus:n,remoteFileUrl:""}),n}async isFileExist(){const e=await Z(this.currentUploadObj.file);this.currentUploadObj.md5Value=e;const s=(await z.head(`${O.baseUrl}/file/exist?md5=${e}&ext=${this.currentUploadObj.fileExt}`)).headers["content-length"]||"0";return parseInt(s)>0}async enqueue(e,t){const s=await this.isFileExist();if(this.chunkUploadQueue.onFinished(()=>{const{md5Value:o,fileName:l,fileExt:p}=this.currentUploadObj,c=o?`${o}.${p}`:l,i=`${O.baseUrl}/file/upload-result?fileName=${c}`;this.currentUploadObj.remoteFileUrl=i,t&&t(this.currentUploadObj)}),s)return;const n=this.splitFile2Chunks();this.chunkUploadQueue.addManyTask(n,async o=>{const{index:l}=o;await this.uploader(l),e&&e(this.currentUploadObj)})}pause(){this.chunkUploadQueue.pause()}async start(){this.chunkUploadQueue.run()}}const se={class:"upload-wrap"},ne=["id","disabled"],le=["for"],ae={class:"progress-loading"},oe={class:"progress-mask"},ue={class:"progress-content"},ie={class:"img-list"},re=["src"],ce=L({__name:"UploadControl",props:{imgList:{type:Array,default(){return[]}},concurrentFileNum:{type:Number,default:2},fileConcurrentChunkNum:{type:Number,default:2},bizId:{type:String,default:""}},emits:["success","update:imgList"],setup(a,{expose:e,emit:t}){const s=a,n=d(!1),o=d([]),l=d([]),p=R(()=>l.value.length?Math.floor(o.value.length/l.value.length*100):0),c=d("");q(()=>{c.value="cpt_"+P(8)});const i=d();function h(){i.value.click()}e({chooseFile:h});function x(m){if(n.value)return;n.value=!0;const u=m.target.files;if(!u)return;const _=Array.from(u);y(_)}async function f(m){return new Promise(async u=>{const _=new E(m,s.fileConcurrentChunkNum);await _.enqueue(null,v=>{let w={imgUrl:v.remoteFileUrl};u(w)}),_.start()})}const F=t;function y(m){l.value=m;const u=new I(s.fileConcurrentChunkNum);u.addManyTask(m,async _=>{const v=await f(_);F("update:imgList",[...s.imgList,v]),F("success",v),o.value.push("")}),u.onFinished(()=>{setTimeout(()=>{n.value=!1,o.value=[],l.value=[]},2e3)}),u.run()}return(m,u)=>{const _=N("el-progress"),v=H("loading");return g(),U("div",se,[r("input",{class:"input",id:c.value,type:"file",multiple:"",disabled:n.value,onChange:x},null,40,ne),r("label",{for:c.value,class:"img-label",ref_key:"multiUploadLabelRef",ref:i},[T(m.$slots,"default",{},()=>[r("div",ae,[J(r("div",oe,null,512),[[v,n.value]]),r("div",ue,[p.value?(g(),K(_,{key:0,type:"circle",width:60,status:`${p.value===100?"success":""}`,percentage:p.value},null,8,["status","percentage"])):$("",!0)])])],!0)],8,le),r("div",ie,[(g(!0),U(A,null,G(a.imgList,(w,B)=>(g(),U("div",{class:"img-item",key:B},[r("img",{src:w.imgUrl,class:"img"},null,8,re)]))),128))])])}}}),de=M(ce,[["__scopeId","data-v-bb8122e3"]]);function pe(a=4,e=.4*1024*1024){const t=d(0),s=d("");let n;return{progress:t,remoteUrl:s,initUpload:async(c,i)=>{n=new E(c,a,e),await n.enqueue(h=>{t.value=h.chunkPercentage},h=>{s.value=h.remoteFileUrl,i&&i()})},startUpload:()=>{n.start()},pauseUpload:()=>{n.pause()}}}const V=a=>(W("data-v-fea1ad3a"),a=a(),X(),a),he={class:"upload"},me={key:0,class:"demo-progress"},fe={key:1,class:"upload-all"},_e=["src"],ge=V(()=>r("h3",null,"上传组件",-1)),ke={class:"mb20"},Ue=V(()=>r("label",{class:"mr16"},"同时上传文件数量",-1)),ve={class:"mb20"},Ce=V(()=>r("label",{class:"mr16"},"单文件切片数量",-1)),be=2,ye=.4*1024*1024,xe=L({__name:"upload",setup(a){const e=d([]);d("");const t=d(3),s=d(4),{progress:n,remoteUrl:o,initUpload:l,pauseUpload:p,startUpload:c}=pe(be,ye),i=d(!1),h=x=>{i.value=!0,l(x.target.files[0],f=>{console.log(f,"upload.vue::73行")})};return(x,f)=>{const F=N("el-progress"),y=N("el-button"),m=N("el-input-number");return g(),U("div",he,[r("input",{type:"file",onChange:h},null,32),i.value?(g(),U("div",me,[k(F,{percentage:b(n)},null,8,["percentage"])])):$("",!0),i.value?(g(),U("div",fe,[k(y,{type:"primary",onClick:b(c)},{default:S(()=>[j("全部片段上传")]),_:1},8,["onClick"]),k(y,{type:"primary",onClick:b(p)},{default:S(()=>[j("中断上传")]),_:1},8,["onClick"]),k(y,{type:"primary",onClick:b(c)},{default:S(()=>[j("继续上传")]),_:1},8,["onClick"])])):$("",!0),b(o)?(g(),U("img",{key:2,class:"img",src:b(o)},null,8,_e)):$("",!0),r("div",null,[ge,r("div",ke,[Ue,k(m,{modelValue:t.value,"onUpdate:modelValue":f[0]||(f[0]=u=>t.value=u),min:1,max:8},null,8,["modelValue"])]),r("div",ve,[Ce,k(m,{modelValue:s.value,"onUpdate:modelValue":f[1]||(f[1]=u=>s.value=u),min:1,max:8},null,8,["modelValue"])]),k(de,{imgList:e.value,"onUpdate:imgList":f[2]||(f[2]=u=>e.value=u),concurrentFileNum:t.value,fileConcurrentChunkNum:s.value},null,8,["imgList","concurrentFileNum","fileConcurrentChunkNum"])])])}}}),je=M(xe,[["__scopeId","data-v-fea1ad3a"]]);export{je as default};
