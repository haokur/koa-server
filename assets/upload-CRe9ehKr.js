var T=Object.defineProperty;var K=(h,a,u)=>a in h?T(h,a,{enumerable:!0,configurable:!0,writable:!0,value:u}):h[a]=u;var I=(h,a,u)=>K(h,typeof a!="symbol"?a+"":a,u);import{A as V,a as R}from"./axios-b2ErKn4C.js";import{h as Y,d as Q,i as v,j as G,o as H,c as F,a as U,k as J,F as W,r as X,b as E,l as Z,e as w,m as tt,f as et,n as L,_ as k,p as j,u as $,w as N,g as O,q as rt,s as nt}from"./index-DP13npZ6.js";function st(h,a){return Math.floor(Math.random()*(a-h+1)+h)}function ot(h){const a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".split("");let u="";const c=a.length;for(let i=0;i<h;i+=1)u+=a[st(0,c)];return u}var P={exports:{}};(function(h,a){(function(u){h.exports=u()})(function(u){var c=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function i(o,s){var e=o[0],t=o[1],n=o[2],r=o[3];e+=(t&n|~t&r)+s[0]-680876936|0,e=(e<<7|e>>>25)+t|0,r+=(e&t|~e&n)+s[1]-389564586|0,r=(r<<12|r>>>20)+e|0,n+=(r&e|~r&t)+s[2]+606105819|0,n=(n<<17|n>>>15)+r|0,t+=(n&r|~n&e)+s[3]-1044525330|0,t=(t<<22|t>>>10)+n|0,e+=(t&n|~t&r)+s[4]-176418897|0,e=(e<<7|e>>>25)+t|0,r+=(e&t|~e&n)+s[5]+1200080426|0,r=(r<<12|r>>>20)+e|0,n+=(r&e|~r&t)+s[6]-1473231341|0,n=(n<<17|n>>>15)+r|0,t+=(n&r|~n&e)+s[7]-45705983|0,t=(t<<22|t>>>10)+n|0,e+=(t&n|~t&r)+s[8]+1770035416|0,e=(e<<7|e>>>25)+t|0,r+=(e&t|~e&n)+s[9]-1958414417|0,r=(r<<12|r>>>20)+e|0,n+=(r&e|~r&t)+s[10]-42063|0,n=(n<<17|n>>>15)+r|0,t+=(n&r|~n&e)+s[11]-1990404162|0,t=(t<<22|t>>>10)+n|0,e+=(t&n|~t&r)+s[12]+1804603682|0,e=(e<<7|e>>>25)+t|0,r+=(e&t|~e&n)+s[13]-40341101|0,r=(r<<12|r>>>20)+e|0,n+=(r&e|~r&t)+s[14]-1502002290|0,n=(n<<17|n>>>15)+r|0,t+=(n&r|~n&e)+s[15]+1236535329|0,t=(t<<22|t>>>10)+n|0,e+=(t&r|n&~r)+s[1]-165796510|0,e=(e<<5|e>>>27)+t|0,r+=(e&n|t&~n)+s[6]-1069501632|0,r=(r<<9|r>>>23)+e|0,n+=(r&t|e&~t)+s[11]+643717713|0,n=(n<<14|n>>>18)+r|0,t+=(n&e|r&~e)+s[0]-373897302|0,t=(t<<20|t>>>12)+n|0,e+=(t&r|n&~r)+s[5]-701558691|0,e=(e<<5|e>>>27)+t|0,r+=(e&n|t&~n)+s[10]+38016083|0,r=(r<<9|r>>>23)+e|0,n+=(r&t|e&~t)+s[15]-660478335|0,n=(n<<14|n>>>18)+r|0,t+=(n&e|r&~e)+s[4]-405537848|0,t=(t<<20|t>>>12)+n|0,e+=(t&r|n&~r)+s[9]+568446438|0,e=(e<<5|e>>>27)+t|0,r+=(e&n|t&~n)+s[14]-1019803690|0,r=(r<<9|r>>>23)+e|0,n+=(r&t|e&~t)+s[3]-187363961|0,n=(n<<14|n>>>18)+r|0,t+=(n&e|r&~e)+s[8]+1163531501|0,t=(t<<20|t>>>12)+n|0,e+=(t&r|n&~r)+s[13]-1444681467|0,e=(e<<5|e>>>27)+t|0,r+=(e&n|t&~n)+s[2]-51403784|0,r=(r<<9|r>>>23)+e|0,n+=(r&t|e&~t)+s[7]+1735328473|0,n=(n<<14|n>>>18)+r|0,t+=(n&e|r&~e)+s[12]-1926607734|0,t=(t<<20|t>>>12)+n|0,e+=(t^n^r)+s[5]-378558|0,e=(e<<4|e>>>28)+t|0,r+=(e^t^n)+s[8]-2022574463|0,r=(r<<11|r>>>21)+e|0,n+=(r^e^t)+s[11]+1839030562|0,n=(n<<16|n>>>16)+r|0,t+=(n^r^e)+s[14]-35309556|0,t=(t<<23|t>>>9)+n|0,e+=(t^n^r)+s[1]-1530992060|0,e=(e<<4|e>>>28)+t|0,r+=(e^t^n)+s[4]+1272893353|0,r=(r<<11|r>>>21)+e|0,n+=(r^e^t)+s[7]-155497632|0,n=(n<<16|n>>>16)+r|0,t+=(n^r^e)+s[10]-1094730640|0,t=(t<<23|t>>>9)+n|0,e+=(t^n^r)+s[13]+681279174|0,e=(e<<4|e>>>28)+t|0,r+=(e^t^n)+s[0]-358537222|0,r=(r<<11|r>>>21)+e|0,n+=(r^e^t)+s[3]-722521979|0,n=(n<<16|n>>>16)+r|0,t+=(n^r^e)+s[6]+76029189|0,t=(t<<23|t>>>9)+n|0,e+=(t^n^r)+s[9]-640364487|0,e=(e<<4|e>>>28)+t|0,r+=(e^t^n)+s[12]-421815835|0,r=(r<<11|r>>>21)+e|0,n+=(r^e^t)+s[15]+530742520|0,n=(n<<16|n>>>16)+r|0,t+=(n^r^e)+s[2]-995338651|0,t=(t<<23|t>>>9)+n|0,e+=(n^(t|~r))+s[0]-198630844|0,e=(e<<6|e>>>26)+t|0,r+=(t^(e|~n))+s[7]+1126891415|0,r=(r<<10|r>>>22)+e|0,n+=(e^(r|~t))+s[14]-1416354905|0,n=(n<<15|n>>>17)+r|0,t+=(r^(n|~e))+s[5]-57434055|0,t=(t<<21|t>>>11)+n|0,e+=(n^(t|~r))+s[12]+1700485571|0,e=(e<<6|e>>>26)+t|0,r+=(t^(e|~n))+s[3]-1894986606|0,r=(r<<10|r>>>22)+e|0,n+=(e^(r|~t))+s[10]-1051523|0,n=(n<<15|n>>>17)+r|0,t+=(r^(n|~e))+s[1]-2054922799|0,t=(t<<21|t>>>11)+n|0,e+=(n^(t|~r))+s[8]+1873313359|0,e=(e<<6|e>>>26)+t|0,r+=(t^(e|~n))+s[15]-30611744|0,r=(r<<10|r>>>22)+e|0,n+=(e^(r|~t))+s[6]-1560198380|0,n=(n<<15|n>>>17)+r|0,t+=(r^(n|~e))+s[13]+1309151649|0,t=(t<<21|t>>>11)+n|0,e+=(n^(t|~r))+s[4]-145523070|0,e=(e<<6|e>>>26)+t|0,r+=(t^(e|~n))+s[11]-1120210379|0,r=(r<<10|r>>>22)+e|0,n+=(e^(r|~t))+s[2]+718787259|0,n=(n<<15|n>>>17)+r|0,t+=(r^(n|~e))+s[9]-343485551|0,t=(t<<21|t>>>11)+n|0,o[0]=e+o[0]|0,o[1]=t+o[1]|0,o[2]=n+o[2]|0,o[3]=r+o[3]|0}function p(o){var s=[],e;for(e=0;e<64;e+=4)s[e>>2]=o.charCodeAt(e)+(o.charCodeAt(e+1)<<8)+(o.charCodeAt(e+2)<<16)+(o.charCodeAt(e+3)<<24);return s}function f(o){var s=[],e;for(e=0;e<64;e+=4)s[e>>2]=o[e]+(o[e+1]<<8)+(o[e+2]<<16)+(o[e+3]<<24);return s}function g(o){var s=o.length,e=[1732584193,-271733879,-1732584194,271733878],t,n,r,_,C,A;for(t=64;t<=s;t+=64)i(e,p(o.substring(t-64,t)));for(o=o.substring(t-64),n=o.length,r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t=0;t<n;t+=1)r[t>>2]|=o.charCodeAt(t)<<(t%4<<3);if(r[t>>2]|=128<<(t%4<<3),t>55)for(i(e,r),t=0;t<16;t+=1)r[t]=0;return _=s*8,_=_.toString(16).match(/(.*?)(.{0,8})$/),C=parseInt(_[2],16),A=parseInt(_[1],16)||0,r[14]=C,r[15]=A,i(e,r),e}function m(o){var s=o.length,e=[1732584193,-271733879,-1732584194,271733878],t,n,r,_,C,A;for(t=64;t<=s;t+=64)i(e,f(o.subarray(t-64,t)));for(o=t-64<s?o.subarray(t-64):new Uint8Array(0),n=o.length,r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t=0;t<n;t+=1)r[t>>2]|=o[t]<<(t%4<<3);if(r[t>>2]|=128<<(t%4<<3),t>55)for(i(e,r),t=0;t<16;t+=1)r[t]=0;return _=s*8,_=_.toString(16).match(/(.*?)(.{0,8})$/),C=parseInt(_[2],16),A=parseInt(_[1],16)||0,r[14]=C,r[15]=A,i(e,r),e}function y(o){var s="",e;for(e=0;e<4;e+=1)s+=c[o>>e*8+4&15]+c[o>>e*8&15];return s}function d(o){var s;for(s=0;s<o.length;s+=1)o[s]=y(o[s]);return o.join("")}d(g("hello")),typeof ArrayBuffer<"u"&&!ArrayBuffer.prototype.slice&&function(){function o(s,e){return s=s|0||0,s<0?Math.max(s+e,0):Math.min(s,e)}ArrayBuffer.prototype.slice=function(s,e){var t=this.byteLength,n=o(s,t),r=t,_,C,A,D;return e!==u&&(r=o(e,t)),n>r?new ArrayBuffer(0):(_=r-n,C=new ArrayBuffer(_),A=new Uint8Array(C),D=new Uint8Array(this,n,_),A.set(D),C)}}();function B(o){return/[\u0080-\uFFFF]/.test(o)&&(o=unescape(encodeURIComponent(o))),o}function S(o,s){var e=o.length,t=new ArrayBuffer(e),n=new Uint8Array(t),r;for(r=0;r<e;r+=1)n[r]=o.charCodeAt(r);return s?n:t}function x(o){return String.fromCharCode.apply(null,new Uint8Array(o))}function M(o,s,e){var t=new Uint8Array(o.byteLength+s.byteLength);return t.set(new Uint8Array(o)),t.set(new Uint8Array(s),o.byteLength),t}function b(o){var s=[],e=o.length,t;for(t=0;t<e-1;t+=2)s.push(parseInt(o.substr(t,2),16));return String.fromCharCode.apply(String,s)}function l(){this.reset()}return l.prototype.append=function(o){return this.appendBinary(B(o)),this},l.prototype.appendBinary=function(o){this._buff+=o,this._length+=o.length;var s=this._buff.length,e;for(e=64;e<=s;e+=64)i(this._hash,p(this._buff.substring(e-64,e)));return this._buff=this._buff.substring(e-64),this},l.prototype.end=function(o){var s=this._buff,e=s.length,t,n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],r;for(t=0;t<e;t+=1)n[t>>2]|=s.charCodeAt(t)<<(t%4<<3);return this._finish(n,e),r=d(this._hash),o&&(r=b(r)),this.reset(),r},l.prototype.reset=function(){return this._buff="",this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},l.prototype.getState=function(){return{buff:this._buff,length:this._length,hash:this._hash.slice()}},l.prototype.setState=function(o){return this._buff=o.buff,this._length=o.length,this._hash=o.hash,this},l.prototype.destroy=function(){delete this._hash,delete this._buff,delete this._length},l.prototype._finish=function(o,s){var e=s,t,n,r;if(o[e>>2]|=128<<(e%4<<3),e>55)for(i(this._hash,o),e=0;e<16;e+=1)o[e]=0;t=this._length*8,t=t.toString(16).match(/(.*?)(.{0,8})$/),n=parseInt(t[2],16),r=parseInt(t[1],16)||0,o[14]=n,o[15]=r,i(this._hash,o)},l.hash=function(o,s){return l.hashBinary(B(o),s)},l.hashBinary=function(o,s){var e=g(o),t=d(e);return s?b(t):t},l.ArrayBuffer=function(){this.reset()},l.ArrayBuffer.prototype.append=function(o){var s=M(this._buff.buffer,o),e=s.length,t;for(this._length+=o.byteLength,t=64;t<=e;t+=64)i(this._hash,f(s.subarray(t-64,t)));return this._buff=t-64<e?new Uint8Array(s.buffer.slice(t-64)):new Uint8Array(0),this},l.ArrayBuffer.prototype.end=function(o){var s=this._buff,e=s.length,t=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],n,r;for(n=0;n<e;n+=1)t[n>>2]|=s[n]<<(n%4<<3);return this._finish(t,e),r=d(this._hash),o&&(r=b(r)),this.reset(),r},l.ArrayBuffer.prototype.reset=function(){return this._buff=new Uint8Array(0),this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},l.ArrayBuffer.prototype.getState=function(){var o=l.prototype.getState.call(this);return o.buff=x(o.buff),o},l.ArrayBuffer.prototype.setState=function(o){return o.buff=S(o.buff,!0),l.prototype.setState.call(this,o)},l.ArrayBuffer.prototype.destroy=l.prototype.destroy,l.ArrayBuffer.prototype._finish=l.prototype._finish,l.ArrayBuffer.hash=function(o,s){var e=m(new Uint8Array(o)),t=d(e);return s?b(t):t},l})})(P);var at=P.exports;const it=Y(at);function ut(h){return new Promise((a,u)=>{const c=new FileReader;c.onload=function(i){var m;const p=new it.ArrayBuffer,f=(m=i.target)==null?void 0:m.result;p.append(f);const g=p.end();a(g)},c.onerror=function(i){u(i)},c.readAsArrayBuffer(h)})}function lt(h){return h.split(".").pop()||""}var z={title:"生产环境",baseUrl:"https://api.haokur.com"};const ct=.4*1024*1024,ht=2;class q{constructor(a,u,c,i){I(this,"currentUploadObj",{chunkSize:1024,file:null,fileName:"",fileExt:"",totalChunk:0,finishedChunk:0,chunkPercentage:0,chunkStatus:[],remoteFileUrl:""});I(this,"splitChunkSize");I(this,"uploader");I(this,"concurrentMax");I(this,"chunkUploadQueue");this.currentUploadObj.file=a,this.currentUploadObj.fileName=a.name,this.currentUploadObj.fileExt=lt(a.name),this.splitChunkSize=c||ct,this.currentUploadObj.chunkSize=this.splitChunkSize,this.uploader=i||this._defaultUploader,this.concurrentMax=u||ht,this.chunkUploadQueue=new V(this.concurrentMax)}async _defaultUploader(a){const u=this.currentUploadObj,c=this.getRangeBufferByIndex(a),{fileName:i,fileExt:p,totalChunk:f,md5Value:g}=u,m=new FormData;m.append("file",c);let y=`${z.baseUrl}/file/upload?fileName=${i}&currentChunkIndex=${a}&totalChunkNum=${f}`;g&&(y+=`&md5=${g}&ext=${p}`),await R.post(y,m).then(()=>{u.finishedChunk+=1;let d=u.finishedChunk/u.totalChunk*100;d=Math.floor(d),u.chunkPercentage=d,u.chunkStatus[a].status=2})}getRangeBufferByIndex(a){const u=this.currentUploadObj.file,c=a*this.splitChunkSize,i=Math.min(c+this.splitChunkSize,u.size);return u.slice(c,i)}splitFile2Chunks(){const a=this.currentUploadObj.file,u=this.splitChunkSize,c=Math.ceil(a.size/u);console.log(a.size,u,c,"FileUploader.ts::101行");const i=Array.from({length:c},(p,f)=>({index:f,start:f*u,end:(f+1)*u,status:0}));return Object.assign(this.currentUploadObj,{file:a,totalChunk:c,fileName:a.name,finishedChunk:0,chunkPercentage:0,chunkStatus:i,remoteFileUrl:""}),i}async isFileExist(){const a=await ut(this.currentUploadObj.file);this.currentUploadObj.md5Value=a;const c=(await R.head(`${z.baseUrl}/file/exist?md5=${a}&ext=${this.currentUploadObj.fileExt}`)).headers["content-length"]||"0";return parseInt(c)>0}async enqueue(a,u){const c=await this.isFileExist();if(console.log("是否存在",c,"FileUploader.ts::136行"),this.chunkUploadQueue.finishCallback=()=>{console.log("执行队列完成的回调finishCallback","FileUploader.ts::139行");const{md5Value:p,fileName:f,fileExt:g}=this.currentUploadObj,m=p?`${p}.${g}`:f,y=`${z.baseUrl}/file/upload-result?fileName=${m}`;this.currentUploadObj.remoteFileUrl=y,u&&u(this.currentUploadObj)},c)return;const i=this.splitFile2Chunks();console.log("切割开的块",i,"FileUploader.ts::150行"),this.chunkUploadQueue.addManyTask(i,async p=>{const{index:f}=p;await this.uploader(f),a&&a(this.currentUploadObj)})}pause(){this.chunkUploadQueue.pause()}async start(){this.chunkUploadQueue.run()}}const ft={class:"upload-wrap"},pt=["id","disabled"],dt=["for"],gt={class:"progress-loading"},mt={class:"progress-mask"},yt={class:"progress-content"},_t={class:"img-list"},bt=["src"],Ut=Q({__name:"UploadControl",props:{imgList:{type:Array,default(){return[]}},concurrentFileNum:{type:Number,default:2},fileConcurrentChunkNum:{type:Number,default:2},bizId:{type:String,default:""}},emits:["success","update:imgList"],setup(h,{expose:a,emit:u}){const c=h,i=v(!1),p=v([]),f=v([]),g=G(()=>f.value.length?Math.floor(p.value.length/f.value.length*100):0),m=v("");H(()=>{m.value="cpt_"+ot(8)});const y=v();function d(){y.value.click()}a({chooseFile:d});function B(b){if(i.value)return;i.value=!0;const l=b.target.files;if(!l)return;const o=Array.from(l);M(o)}async function S(b){return new Promise(async l=>{const o=new q(b,c.fileConcurrentChunkNum);await o.enqueue(null,s=>{let e={imgUrl:s.remoteFileUrl};console.log("成功回调","UploadControl.vue::92行"),l(e)}),console.log("单个文件添加队列完成","UploadControl.vue::94行"),o.start()})}const x=u;function M(b){f.value=b;const l=new V(c.fileConcurrentChunkNum);l.addManyTask(b,async o=>{const s=await S(o);x("update:imgList",[...c.imgList,s]),x("success",s),p.value.push("")}),l.finishCallback=()=>{setTimeout(()=>{i.value=!1,p.value=[],f.value=[]},2e3)},l.run()}return(b,l)=>{const o=E("el-progress"),s=Z("loading");return w(),F("div",ft,[U("input",{class:"input",id:m.value,type:"file",multiple:"",disabled:i.value,onChange:B},null,40,pt),U("label",{for:m.value,class:"img-label",ref_key:"multiUploadLabelRef",ref:y},[J(b.$slots,"default",{},()=>[U("div",gt,[tt(U("div",mt,null,512),[[s,i.value]]),U("div",yt,[g.value?(w(),et(o,{key:0,type:"circle",width:60,status:`${g.value===100?"success":""}`,percentage:g.value},null,8,["status","percentage"])):L("",!0)])])],!0)],8,dt),U("div",_t,[(w(!0),F(W,null,X(h.imgList,(e,t)=>(w(),F("div",{class:"img-item",key:t},[U("img",{src:e.imgUrl,class:"img"},null,8,bt)]))),128))])])}}}),vt=k(Ut,[["__scopeId","data-v-cacdf413"]]);function Ct(h=4,a=.4*1024*1024){const u=v(0),c=v("");let i;return{progress:u,remoteUrl:c,initUpload:async(m,y)=>{i=new q(m,h,a),await i.enqueue(d=>{u.value=d.chunkPercentage},d=>{c.value=d.remoteFileUrl,y&&y()})},startUpload:()=>{i.start()},pauseUpload:()=>{i.pause()}}}const At=h=>(rt("data-v-4f15750a"),h=h(),nt(),h),wt={class:"upload"},St={key:0,class:"demo-progress"},Ft={key:1,class:"upload-all"},Bt=["src"],xt=At(()=>U("h3",null,"上传组件",-1)),It=2,$t=.4*1024*1024,jt=Q({__name:"upload",setup(h){const a=v([]);v("");const{progress:u,remoteUrl:c,initUpload:i,pauseUpload:p,startUpload:f}=Ct(It,$t),g=v(!1),m=y=>{g.value=!0,i(y.target.files[0],d=>{console.log(d,"upload.vue::73行")})};return(y,d)=>{const B=E("el-progress"),S=E("el-button");return w(),F("div",wt,[U("input",{type:"file",onChange:m},null,32),g.value?(w(),F("div",St,[j(B,{percentage:$(u)},null,8,["percentage"])])):L("",!0),g.value?(w(),F("div",Ft,[j(S,{type:"primary",onClick:$(f)},{default:N(()=>[O("全部片段上传")]),_:1},8,["onClick"]),j(S,{type:"primary",onClick:$(p)},{default:N(()=>[O("中断上传")]),_:1},8,["onClick"]),j(S,{type:"primary",onClick:$(f)},{default:N(()=>[O("继续上传")]),_:1},8,["onClick"])])):L("",!0),$(c)?(w(),F("img",{key:2,class:"img",src:$(c)},null,8,Bt)):L("",!0),U("div",null,[xt,j(vt,{imgList:a.value,"onUpdate:imgList":d[0]||(d[0]=x=>a.value=x)},null,8,["imgList"])])])}}}),Ot=k(jt,[["__scopeId","data-v-4f15750a"]]);export{Ot as default};
//# sourceMappingURL=upload-CRe9ehKr.js.map
