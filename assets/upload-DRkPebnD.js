var Q=Object.defineProperty;var R=(l,e,t)=>e in l?Q(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t;var g=(l,e,t)=>R(l,typeof e!="symbol"?e+"":e,t);import{a as q,A as z}from"./axios-b2ErKn4C.js";import{d as I,h as d,i as P,o as V,c as _,a as c,j as A,F as D,r as T,b as j,k as E,e as f,l as K,f as Y,m as S,_ as M,n as b,u as v,w as L,g as F,p as G,q as H}from"./index-BBuLeBc2.js";function J(l,e){return Math.floor(Math.random()*(e-l+1)+l)}function W(l){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".split("");let t="";const n=e.length;for(let s=0;s<l;s+=1)t+=e[J(0,n)];return t}var x={title:"生产环境",baseUrl:"http://localhost:3000"};class O{constructor(e,t=2,n=this.defaultChunkSize,s){g(this,"currentUploadObj",{chunkSize:1024,file:null,fileName:"",totalChunk:0,finishedChunk:0,chunkPercentage:0,chunkStatus:[],remoteFileUrl:""});g(this,"splitChunkSize");g(this,"uploader");g(this,"defaultChunkSize",.4*1024*1024);g(this,"concurrentMax");g(this,"chunkUploadQueue");this.currentUploadObj.file=e,this.currentUploadObj.chunkSize=n,this.splitChunkSize=n,this.uploader=s||this._defaultUploader,this.concurrentMax=t}async _defaultUploader(e){const t=this.currentUploadObj,n=this.getRangeBufferByIndex(e),{fileName:s,totalChunk:o}=t,a=new FormData;a.append("file",n);const r=`${x.baseUrl}/file/upload?fileName=${s}&currentChunkIndex=${e}&totalChunkNum=${o}`;await q.post(r,a).then(()=>{t.finishedChunk+=1;let u=t.finishedChunk/t.totalChunk*100;u=Math.floor(u),t.chunkPercentage=u,t.chunkStatus[e].status=2})}getRangeBufferByIndex(e){const t=this.currentUploadObj.file,n=e*this.splitChunkSize,s=Math.min(n+this.splitChunkSize,t.size);return t.slice(n,s)}splitFile2Chunks(){const e=this.currentUploadObj.file,t=this.splitChunkSize,n=Math.ceil(e.size/t),s=Array.from({length:n},(o,a)=>({index:a,start:a*t,end:(a+1)*t,status:0}));return Object.assign(this.currentUploadObj,{file:e,totalChunk:n,fileName:e.name,finishedChunk:0,chunkPercentage:0,chunkStatus:s,remoteFileUrl:""}),s}enqueue(e,t){this.chunkUploadQueue=new z(this.concurrentMax),this.chunkUploadQueue.finishCallback=()=>{const s=`${x.baseUrl}/file/upload-result?fileName=${this.currentUploadObj.fileName}`;this.currentUploadObj.remoteFileUrl=s,t&&t(this.currentUploadObj)};const n=this.splitFile2Chunks();this.chunkUploadQueue.addManyTask(n,async s=>{const{index:o}=s;await this.uploader(o),e&&e(this.currentUploadObj)})}pause(){this.chunkUploadQueue.pause()}start(){this.chunkUploadQueue.run()}}const X={class:"upload-wrap"},Z=["id","disabled"],ee=["for"],te={class:"progress-loading"},se={class:"progress-mask"},ne={class:"progress-content"},le={class:"img-list"},ae=["src"],oe=I({__name:"UploadControl",props:{imgList:{type:Array,default(){return[]}},concurrentFileNum:{type:Number,default:2},fileConcurrentChunkNum:{type:Number,default:2},bizId:{type:String,default:""}},emits:["success","update:imgList"],setup(l,{expose:e,emit:t}){const n=l,s=d(!1),o=d([]),a=d([]),r=P(()=>a.value.length?Math.floor(o.value.length/a.value.length*100):0),u=d("");V(()=>{u.value="cpt_"+W(8)});const p=d();function i(){p.value.click()}e({chooseFile:i});function N(h){if(s.value)return;s.value=!0;let m=Array.from(h.target.files);$(m)}async function C(h){return new Promise(m=>{const k=new O(h,n.fileConcurrentChunkNum);k.enqueue(null,U=>{let w={imgUrl:U.remoteFileUrl};m(w)}),k.start()})}const y=t;function $(h){a.value=h;const m=new z(n.fileConcurrentChunkNum);m.addManyTask(h,async k=>{const U=await C(k);y("update:imgList",[...n.imgList,U]),y("success",U),o.value.push("")}),m.finishCallback=()=>{setTimeout(()=>{s.value=!1,o.value=[],a.value=[]},2e3)},m.run()}return(h,m)=>{const k=j("el-progress"),U=E("loading");return f(),_("div",X,[c("input",{class:"input",id:u.value,type:"file",multiple:"",disabled:s.value,onChange:N},null,40,Z),c("label",{for:u.value,class:"img-label",ref_key:"multiUploadLabelRef",ref:p},[A(h.$slots,"default",{},()=>[c("div",te,[K(c("div",se,null,512),[[U,s.value]]),c("div",ne,[r.value?(f(),Y(k,{key:0,type:"circle",width:60,status:`${r.value===100?"success":""}`,percentage:r.value},null,8,["status","percentage"])):S("",!0)])])],!0)],8,ee),c("div",le,[(f(!0),_(D,null,T(l.imgList,(w,B)=>(f(),_("div",{class:"img-item",key:B},[c("img",{src:w.imgUrl,class:"img"},null,8,ae)]))),128))])])}}}),ue=M(oe,[["__scopeId","data-v-e4739cc4"]]);function re(l=4,e=.4*1024*1024){const t=d(0),n=d("");let s=null;return{progress:t,remoteUrl:n,initUpload:(u,p)=>{s=new O(u,l,e),s.enqueue(i=>{t.value=i.chunkPercentage},i=>{n.value=i.remoteFileUrl,p&&p()})},startUpload:()=>{s.start()},pauseUpload:()=>{s.pause()}}}const ie=l=>(G("data-v-75ee0ce7"),l=l(),H(),l),ce={class:"upload"},de={key:0,class:"demo-progress"},pe={key:1,class:"upload-all"},he=["src"],me=ie(()=>c("h3",null,"上传组件",-1)),fe=2,ge=.4*1024*1024,_e=I({__name:"upload",setup(l){const e=d([]),{progress:t,remoteUrl:n,initUpload:s,pauseUpload:o,startUpload:a}=re(fe,ge),r=d(!1),u=p=>{r.value=!0,s(p.target.files[0],i=>{console.log(i,"upload.vue::73行")})};return(p,i)=>{const N=j("el-progress"),C=j("el-button");return f(),_("div",ce,[c("input",{type:"file",onChange:u},null,32),r.value?(f(),_("div",de,[b(N,{percentage:v(t)},null,8,["percentage"])])):S("",!0),r.value?(f(),_("div",pe,[b(C,{type:"primary",onClick:v(a)},{default:L(()=>[F("全部片段上传")]),_:1},8,["onClick"]),b(C,{type:"primary",onClick:v(o)},{default:L(()=>[F("中断上传")]),_:1},8,["onClick"]),b(C,{type:"primary",onClick:v(a)},{default:L(()=>[F("继续上传")]),_:1},8,["onClick"])])):S("",!0),v(n)?(f(),_("img",{key:2,class:"img",src:v(n)},null,8,he)):S("",!0),c("div",null,[me,b(ue,{imgList:e.value,"onUpdate:imgList":i[0]||(i[0]=y=>e.value=y)},null,8,["imgList"])])])}}}),Ce=M(_e,[["__scopeId","data-v-75ee0ce7"]]);export{Ce as default};
