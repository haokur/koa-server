import{A as w,a as B}from"./AsyncQueue-DG5LUosy.js";import{d as D,h as I,i as M,j as V,c as i,a as f,k as d,l as m,F as $,r as A,w as p,t as C,b as g,e as c,f as P,g as h,_ as j}from"./index-OVr9dYAz.js";const z={class:"upload"},R={key:0,class:"demo-progress"},T={class:"steps"},O={key:1,class:"upload-all"},Q=["src"],r=.4*1024*1024,q=2,E=D({__name:"upload",setup(L){const k=I(null),e=M({chunkSize:r,file:null,fileName:"",totalChunk:0,finishedChunk:0,chunkPercentage:0,chunkStatus:[],remoteFileUrl:""}),_=V(()=>!!e.totalChunk),b=t=>{const s=t.target.files[0];let n=Math.ceil(s.size/r),a=Array.from({length:n},(u,o)=>({index:o,start:o*r,end:(o+1)*r,status:0}));Object.assign(e,{file:s,totalChunk:n,fileName:s.name,finishedChunk:0,chunkPercentage:0,chunkStatus:a,remoteFileUrl:""})};async function v(t){const s=F(t);let{fileName:n,totalChunk:a}=e;const u=new FormData;u.append("file",s),await B.post(`http://localhost:3000/file/upload?fileName=${n}&currentChunkIndex=${t}&totalChunkNum=${a}`,u).then(o=>{e.finishedChunk+=1,e.chunkPercentage=Math.floor(e.finishedChunk/e.totalChunk*100),e.chunkStatus[t].status=2,o.data.msg==="finished"&&(e.remoteFileUrl=`http://localhost:3000/file/upload-result?fileName=${n}`)})}const F=t=>{const s=k.value.files[0],n=t*r,a=Math.min(n+r,s.size);return s.slice(n,a)},l=new w(q,!0),y=async t=>{await v(t.index)},N=async t=>{l.addTask(e.chunkStatus[t],y),l.run()};async function x(){l.addManyTask(e.chunkStatus,y),l.run()}const S=()=>{l.pause()},U=()=>{l.run()};return(t,s)=>{const n=g("el-progress"),a=g("el-button");return c(),i("div",z,[f("input",{type:"file",onChange:b,ref_key:"inputRef",ref:k},null,544),_.value?(c(),i("div",R,[d(n,{percentage:e.chunkPercentage},null,8,["percentage"])])):m("",!0),f("div",T,[(c(!0),i($,null,A(e.totalChunk,(u,o)=>(c(),P(a,{key:o,type:"primary",onClick:G=>N(o)},{default:p(()=>[h(" 上传片段"+C(o+1),1)]),_:2},1032,["onClick"]))),128))]),_.value?(c(),i("div",O,[d(a,{type:"primary",onClick:x},{default:p(()=>[h("全部片段上传")]),_:1}),d(a,{type:"primary",onClick:S},{default:p(()=>[h("中断上传")]),_:1}),d(a,{type:"primary",onClick:U},{default:p(()=>[h("继续上传")]),_:1})])):m("",!0),e.remoteFileUrl?(c(),i("img",{key:2,class:"img",src:e.remoteFileUrl},null,8,Q)):m("",!0),f("div",null,C(e),1)])}}}),K=j(E,[["__scopeId","data-v-64eb57cc"]]);export{K as default};
