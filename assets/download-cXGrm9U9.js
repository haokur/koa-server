import{d as w,h as b,l as v,c as g,i as R,v as _,a as y,n as U,w as x,b as z,e as C,g as S}from"./index-HO1tAa6s.js";import{A as B,a as D}from"./AsyncQueue-DG5LUosy.js";var N={title:"生产环境",baseUrl:"http://localhost:3000"};const F={class:"download"},L=2,V=w({__name:"download",setup(j){const u=Math.floor(419430.4),s=b("f1708607957313.png"),a=v({fileName:"",fileUrl:"",fileRemoteUrl:"",totalFileSize:0,chunkSize:u,chunkRanges:[],chunkRangeData:[]}),f=()=>{if(!s.value)return;s.value!==a.fileName&&Object.assign(a,{fileName:s.value,fileRemoteUrl:"",totalFileSize:0,chunkSize:u,chunkRanges:[],chunkRangeData:[]});const e=`${N.baseUrl}/file/download?fileName=${s.value}`;k(e)};async function h(){const e=a.chunkRangeData.reduce((l,c)=>[...l,c],[]),o=new Blob(e),t=URL.createObjectURL(o),n=document.createElement("a");n.href=t,n.download="downloaded_file.png",document.body.appendChild(n),n.click(),URL.revokeObjectURL(t)}const i=new B(L,!0);i.finishCallback=h;async function p(e){const t=(await D.head(e)).headers["content-length"]||"0",n=parseInt(t);a.totalFileSize=n;let l=-1,c=0;for(;l<n;){const r=l+1,d=l+a.chunkSize;a.chunkRanges.push({start:r,end:d,status:0,index:c}),l=d,c++}}async function k(e){e!==a.fileUrl&&(i.clear(),a.fileUrl=e,await p(e));const o=async t=>{let{index:n,start:l,end:c}=t;const r=await m(e,l,c);a.chunkRangeData[n]=r};i.addManyTask(a.chunkRanges,o),i.run()}async function m(e,o,t){return await(await fetch(e,{headers:{Range:`bytes=${o}-${t}`}})).arrayBuffer()}return(e,o)=>{const t=z("el-button");return C(),g("div",F,[R(y("input",{type:"text","onUpdate:modelValue":o[0]||(o[0]=n=>s.value=n)},null,512),[[_,s.value]]),U(t,{onClick:f},{default:x(()=>[S("开始分片下载")]),_:1})])}}});export{V as default};
