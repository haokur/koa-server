import{a as V}from"./axios-B4uVmeYG.js";import{d as w,h as B,i as D,j as S,c as i,a as d,k as g,l as p,F as R,r as $,w as y,t as N,b,e as r,f as M,g as v,_ as P}from"./index-jW0kkPld.js";const Q={class:"upload"},j={key:0,class:"demo-progress"},z={class:"steps"},A={key:1,class:"upload-all"},E=["src"],c=.4*1024*1024,O=2,L=w({__name:"upload",setup(T){const f=B(null),t=D({chunkSize:c,file:null,fileName:"",totalChunk:0,finishedChunk:0,chunkPercentage:0,chunkStatus:[],remoteFileUrl:""}),m=S(()=>!!t.totalChunk),F=e=>{const n=e.target.files[0];let a=Math.ceil(n.size/c),s=Array.from({length:a},(u,l)=>({index:l,start:l*c,end:(l+1)*c,status:0}));Object.assign(t,{file:n,totalChunk:a,fileName:n.name,finishedChunk:0,chunkPercentage:0,chunkStatus:s,remoteFileUrl:""})};let o=[],h=[];const k=async e=>{o.includes(e)||h.includes(e)||t.finishedChunk===t.totalChunk||(h.push(e),_())};function _(){let e=O-o.length;if(e){let n=h.splice(0,e);o=[...o,...n],n.forEach(a=>{x(a)})}}async function x(e){const n=I(e);let{fileName:a,totalChunk:s}=t;const u=new FormData;u.append("file",n),await V.post(`http://localhost:3000/file/upload?filename=${a}&currentChunkIndex=${e}&totalChunkNum=${s}`,u).then(l=>{o=o.filter(C=>C!==e),_(),t.finishedChunk+=1,t.chunkPercentage=Math.floor(t.finishedChunk/t.totalChunk*100),t.chunkStatus[e].status=2,l.data.msg==="finished"&&(t.remoteFileUrl=`http://localhost:3000/file/upload-result?fileName=${a}`)})}const I=e=>{const n=f.value.files[0],a=e*c,s=Math.min(a+c,n.size);return n.slice(a,s)};async function U(){for(let e=0;e<t.totalChunk;e++)k(e)}return(e,n)=>{const a=b("el-progress"),s=b("el-button");return r(),i("div",Q,[d("input",{type:"file",onChange:F,ref_key:"inputRef",ref:f},null,544),m.value?(r(),i("div",j,[g(a,{percentage:t.chunkPercentage},null,8,["percentage"])])):p("",!0),d("div",z,[(r(!0),i(R,null,$(t.totalChunk,(u,l)=>(r(),M(s,{key:l,type:"primary",onClick:C=>k(l)},{default:y(()=>[v(" 上传片段"+N(l+1),1)]),_:2},1032,["onClick"]))),128))]),m.value?(r(),i("div",A,[g(s,{type:"primary",onClick:U},{default:y(()=>[v("全部片段上传")]),_:1})])):p("",!0),t.remoteFileUrl?(r(),i("img",{key:2,class:"img",src:t.remoteFileUrl},null,8,E)):p("",!0),d("div",null,N(t),1)])}}}),H=P(L,[["__scopeId","data-v-61a7e990"]]);export{H as default};
