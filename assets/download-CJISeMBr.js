var T=Object.defineProperty;var b=(s,e,t)=>e in s?T(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var a=(s,e,t)=>b(s,typeof e!="symbol"?e+"":e,t);import{d as x,h as _,i as y,c as v,m as z,v as B,a as C,k as N,w as U,b as D,e as F,g as L}from"./index-BR-DgThp.js";import{a as M}from"./axios-B4uVmeYG.js";class j{constructor(e,t,n){a(this,"allQueen",[]);a(this,"allTaskQueen",[]);a(this,"totalTask",0);a(this,"queenMax",1);a(this,"callback",async e=>null);a(this,"workQueenSet");a(this,"canRun",!0);this.allQueen=e,this.allTaskQueen=e.map(this.configureTask),this.totalTask=this.allTaskQueen.length,this.queenMax=t,this.callback=n,this.workQueenSet=new Set}configureTask(e,t){return{task:e,index:t}}add(e,t){const n=this.totalTask+1;this.allTaskQueen.push(this.configureTask(e,n)),t&&(this.callback=t)}stop(){this.canRun=!1}async start(){this.canRun=!0,await this.run()}run(){return new Promise((e,t)=>{function n(){if(!this.canRun)return t("中断执行");if(this.workQueenSet.size===0&&this.allTaskQueen.length===0)return e();const p=this.queenMax-this.workQueenSet.size,k=this.allTaskQueen.splice(0,p);k.length&&k.forEach(c=>{this.workQueenSet.add(c),this.callback(c).then(()=>{this.workQueenSet.delete(c),n.apply(this)})})}n.apply(this)})}}const E={class:"download"},$=x({__name:"download",setup(s){const e=Math.floor(419430.4),t=_("f1708607957313.png"),n=y({fileName:"",fileRemoteUrl:"",totalFileSize:0,chunkSize:e,chunkRanges:[],chunkRangeData:[]}),p=()=>{if(!t.value)return;Object.assign(n,{fileName:t.value,fileRemoteUrl:"",totalFileSize:0,chunkSize:e,chunkRanges:[],chunkRangeData:[]});const o=`http://localhost:3000/file/download?fileName=${t.value}`;k(o)};async function k(o){const r=(await M.head(o)).headers["content-length"]||"0",u=parseInt(r);n.totalFileSize=u;let h=-1;for(;h<u;){const d=h+1,l=h+n.chunkSize;n.chunkRanges.push({start:d,end:l,status:0}),h=l}const m=2;await new j(n.chunkRanges,m,async d=>{let{task:l,index:S}=d;const Q=await c(o,l.start,l.end);n.chunkRangeData[S]=Q}).start();const g=n.chunkRangeData.reduce((d,l)=>[...d,l],[]),R=new Blob(g),w=URL.createObjectURL(R),f=document.createElement("a");f.href=w,f.download="downloaded_file.png",document.body.appendChild(f),f.click(),URL.revokeObjectURL(w)}async function c(o,i,r){return await(await fetch(o,{headers:{Range:`bytes=${i}-${r}`}})).arrayBuffer()}return(o,i)=>{const r=D("el-button");return F(),v("div",E,[z(C("input",{type:"text","onUpdate:modelValue":i[0]||(i[0]=u=>t.value=u)},null,512),[[B,t.value]]),N(r,{onClick:p},{default:U(()=>[L("开始分片下载")]),_:1})])}}});export{$ as default};
