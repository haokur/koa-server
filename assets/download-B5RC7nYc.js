import{d as m,h as g,i as v,c as b,m as R,v as y,a as U,k as _,w as x,b as z,e as C,g as S}from"./index-OVr9dYAz.js";import{A as B,a as D}from"./AsyncQueue-DG5LUosy.js";const N={class:"download"},F=2,O=m({__name:"download",setup(L){const d=Math.floor(419430.4),s=g("f1708607957313.png"),n=v({fileName:"",fileUrl:"",fileRemoteUrl:"",totalFileSize:0,chunkSize:d,chunkRanges:[],chunkRangeData:[]}),f=()=>{if(!s.value)return;s.value!==n.fileName&&Object.assign(n,{fileName:s.value,fileRemoteUrl:"",totalFileSize:0,chunkSize:d,chunkRanges:[],chunkRangeData:[]});const e=`http://localhost:3000/file/download?fileName=${s.value}`;k(e)};async function h(){console.log(n,"download.vue::56行");const e=n.chunkRangeData.reduce((l,c)=>[...l,c],[]),o=new Blob(e),t=URL.createObjectURL(o),a=document.createElement("a");a.href=t,a.download="downloaded_file.png",document.body.appendChild(a),a.click(),URL.revokeObjectURL(t)}const i=new B(F,!0);i.finishCallback=h;async function p(e){const t=(await D.head(e)).headers["content-length"]||"0",a=parseInt(t);n.totalFileSize=a;let l=-1,c=0;for(;l<a;){const r=l+1,u=l+n.chunkSize;n.chunkRanges.push({start:r,end:u,status:0,index:c}),l=u,c++}}async function k(e){console.log(e,n.fileUrl,"download.vue::104行"),e!==n.fileUrl&&(i.clear(),n.fileUrl=e,await p(e));const o=async t=>{let{index:a,start:l,end:c}=t;const r=await w(e,l,c);n.chunkRangeData[a]=r};i.addManyTask(n.chunkRanges,o),i.run()}async function w(e,o,t){return await(await fetch(e,{headers:{Range:`bytes=${o}-${t}`}})).arrayBuffer()}return(e,o)=>{const t=z("el-button");return C(),b("div",N,[R(U("input",{type:"text","onUpdate:modelValue":o[0]||(o[0]=a=>s.value=a)},null,512),[[y,s.value]]),_(t,{onClick:f},{default:x(()=>[S("开始分片下载")]),_:1})])}}});export{O as default};
