import{d as w,g as b,s as v,c as g,l as R,v as U,a as _,n as y,w as x,b as C,o as z,f as S}from"./index-B4klwQPo.js";import{a as B}from"./axios-B4uVmeYG.js";import{M as D}from"./MultiChannel-CkJFUiEV.js";var N={title:"生产环境",baseUrl:"https://api.haokur.com",workerBaseUrl:"workers"};const F={class:"download"},L=2,V=w({__name:"download",setup(M){const i=Math.floor(419430.4),s=b("cb266c4e2f66de54c5fd04073a713579.png"),a=v({fileName:"",fileUrl:"",fileRemoteUrl:"",totalFileSize:0,chunkSize:i,chunkRanges:[],chunkRangeData:[]}),f=()=>{if(!s.value)return;s.value!==a.fileName&&Object.assign(a,{fileName:s.value,fileRemoteUrl:"",totalFileSize:0,chunkSize:i,chunkRanges:[],chunkRangeData:[]});const e=`${N.baseUrl}/file/download?fileName=${s.value}`;k(e)};async function h(){const e=a.chunkRangeData.reduce((l,c)=>[...l,c],[]),o=new Blob(e),t=URL.createObjectURL(o),n=document.createElement("a");n.href=t,n.download="downloaded_file.png",document.body.appendChild(n),n.click(),URL.revokeObjectURL(t)}async function p(e){const t=(await B.head(e)).headers["content-length"]||"0",n=parseInt(t);a.totalFileSize=n;let l=-1,c=0;for(;l<n;){const r=l+1,u=l+a.chunkSize;a.chunkRanges.push({start:r,end:u,status:0,index:c}),l=u,c++}}const d=new D(L);async function k(e){e!==a.fileUrl&&(d.clear(),a.fileUrl=e,await p(e));const o=async t=>{let{index:n,start:l,end:c}=t;const r=await m(e,l,c);a.chunkRangeData[n]=r};d.onFinished(h).addManyTask(a.chunkRanges,o).run()}async function m(e,o,t){return await(await fetch(e,{headers:{Range:`bytes=${o}-${t}`}})).arrayBuffer()}return(e,o)=>{const t=C("el-button");return z(),g("div",F,[R(_("input",{type:"text","onUpdate:modelValue":o[0]||(o[0]=n=>s.value=n)},null,512),[[U,s.value]]),y(t,{onClick:f},{default:x(()=>[S("开始分片下载")]),_:1})])}}});export{V as default};
