var D=Object.defineProperty;var Q=(l,e,t)=>e in l?D(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t;var C=(l,e,t)=>Q(l,typeof e!="symbol"?e+"":e,t);import{a as L}from"./axios-B4uVmeYG.js";import{g as R,a as q}from"./file.util-W3Is1M-v.js";import{M as z}from"./MultiChannel-CkJFUiEV.js";import{d as V,g as d,h as P,i as T,c as U,a as i,j as A,F as K,r as Y,b as N,k as G,o as g,l as H,e as J,m as w,_ as I,n as k,u as b,w as S,f as j,p as W,q as X}from"./index-B4klwQPo.js";function Z(l,e){return Math.floor(Math.random()*(e-l+1)+l)}function ee(l){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".split("");let t="";const s=e.length;for(let n=0;n<l;n+=1)t+=e[Z(0,s)];return t}var O={title:"生产环境",baseUrl:"https://api.haokur.com",workerBaseUrl:"workers"};const te=.4*1024*1024,se=2;class E{constructor(e,t,s,n){C(this,"currentUploadObj",{chunkSize:1024,file:null,fileName:"",fileExt:"",totalChunk:0,finishedChunk:0,chunkPercentage:0,chunkStatus:[],remoteFileUrl:""});C(this,"splitChunkSize");C(this,"uploader");C(this,"concurrentMax");C(this,"chunkUploadQueue");this.currentUploadObj.file=e,this.currentUploadObj.fileName=e.name,this.currentUploadObj.fileExt=R(e.name),this.splitChunkSize=s||te,this.currentUploadObj.chunkSize=this.splitChunkSize,this.uploader=n||this._defaultUploader,this.concurrentMax=t||se,this.chunkUploadQueue=new z(this.concurrentMax)}async _defaultUploader(e){const t=this.currentUploadObj,s=this.getRangeBufferByIndex(e),{fileName:n,fileExt:o,totalChunk:a,md5Value:p}=t,c=new FormData;c.append("file",s);let r=`${O.baseUrl}/file/upload?fileName=${n}&currentChunkIndex=${e}&totalChunkNum=${a}`;p&&(r+=`&md5=${p}&ext=${o}`),await L.post(r,c).then(()=>{t.finishedChunk+=1;let h=t.finishedChunk/t.totalChunk*100;h=Math.floor(h),t.chunkPercentage=h,t.chunkStatus[e].status=2})}getRangeBufferByIndex(e){const t=this.currentUploadObj.file,s=e*this.splitChunkSize,n=Math.min(s+this.splitChunkSize,t.size);return t.slice(s,n)}splitFile2Chunks(){const e=this.currentUploadObj.file,t=this.splitChunkSize,s=Math.ceil(e.size/t),n=Array.from({length:s},(o,a)=>({index:a,start:a*t,end:(a+1)*t,status:0}));return Object.assign(this.currentUploadObj,{file:e,totalChunk:s,fileName:e.name,finishedChunk:0,chunkPercentage:0,chunkStatus:n,remoteFileUrl:""}),n}async isFileExist(){const e=await q(this.currentUploadObj.file);this.currentUploadObj.md5Value=e;const s=(await L.head(`${O.baseUrl}/file/exist?md5=${e}&ext=${this.currentUploadObj.fileExt}`)).headers["content-length"]||"0";return parseInt(s)>0}async enqueue(e,t){const s=await this.isFileExist();if(this.chunkUploadQueue.onFinished(()=>{const{md5Value:o,fileName:a,fileExt:p}=this.currentUploadObj,c=o?`${o}.${p}`:a,r=`${O.baseUrl}/file/upload-result?fileName=${c}`;this.currentUploadObj.remoteFileUrl=r,t&&t(this.currentUploadObj)}),s)return;const n=this.splitFile2Chunks();this.chunkUploadQueue.addManyTask(n,async o=>{const{index:a}=o;await this.uploader(a),e&&e(this.currentUploadObj)})}pause(){this.chunkUploadQueue.pause()}async start(){this.chunkUploadQueue.run()}}const ne={class:"upload-wrap"},le=["id","disabled"],ae=["for"],oe={class:"progress-loading"},ue={class:"progress-mask"},re={class:"progress-content"},ie={class:"img-list"},ce=["src"],de=V({__name:"UploadControl",props:{imgList:{type:Array,default(){return[]}},concurrentFileNum:{type:Number,default:2},fileConcurrentChunkNum:{type:Number,default:2},bizId:{type:String,default:""}},emits:["success","update:imgList"],setup(l,{expose:e,emit:t}){const s=l,n=d(!1),o=d([]),a=d([]),p=P(()=>a.value.length?Math.floor(o.value.length/a.value.length*100):0),c=d("");T(()=>{c.value="cpt_"+ee(8)});const r=d();function h(){r.value.click()}e({chooseFile:h});function x(m){if(n.value)return;n.value=!0;const u=m.target.files;if(!u)return;const _=Array.from(u);y(_)}async function f(m){return new Promise(async u=>{const _=new E(m,s.fileConcurrentChunkNum);await _.enqueue(null,v=>{let $={imgUrl:v.remoteFileUrl};u($)}),_.start()})}const F=t;function y(m){a.value=m;const u=new z(s.fileConcurrentChunkNum);u.addManyTask(m,async _=>{const v=await f(_);F("update:imgList",[...s.imgList,v]),F("success",v),o.value.push("")}),u.onFinished(()=>{setTimeout(()=>{n.value=!1,o.value=[],a.value=[]},2e3)}),u.run()}return(m,u)=>{const _=N("el-progress"),v=G("loading");return g(),U("div",ne,[i("input",{class:"input",id:c.value,type:"file",multiple:"",disabled:n.value,onChange:x},null,40,le),i("label",{for:c.value,class:"img-label",ref_key:"multiUploadLabelRef",ref:r},[A(m.$slots,"default",{},()=>[i("div",oe,[H(i("div",ue,null,512),[[v,n.value]]),i("div",re,[p.value?(g(),J(_,{key:0,type:"circle",width:60,status:`${p.value===100?"success":""}`,percentage:p.value},null,8,["status","percentage"])):w("",!0)])])],!0)],8,ae),i("div",ie,[(g(!0),U(K,null,Y(l.imgList,($,B)=>(g(),U("div",{class:"img-item",key:B},[i("img",{src:$.imgUrl,class:"img"},null,8,ce)]))),128))])])}}}),pe=I(de,[["__scopeId","data-v-bb8122e3"]]);function he(l=4,e=.4*1024*1024){const t=d(0),s=d("");let n;return{progress:t,remoteUrl:s,initUpload:async(c,r)=>{n=new E(c,l,e),await n.enqueue(h=>{t.value=h.chunkPercentage},h=>{s.value=h.remoteFileUrl,r&&r()})},startUpload:()=>{n.start()},pauseUpload:()=>{n.pause()}}}const M=l=>(W("data-v-fea1ad3a"),l=l(),X(),l),me={class:"upload"},fe={key:0,class:"demo-progress"},_e={key:1,class:"upload-all"},ge=["src"],ke=M(()=>i("h3",null,"上传组件",-1)),Ue={class:"mb20"},ve=M(()=>i("label",{class:"mr16"},"同时上传文件数量",-1)),Ce={class:"mb20"},be=M(()=>i("label",{class:"mr16"},"单文件切片数量",-1)),ye=2,xe=.4*1024*1024,Fe=V({__name:"upload",setup(l){const e=d([]);d("");const t=d(3),s=d(4),{progress:n,remoteUrl:o,initUpload:a,pauseUpload:p,startUpload:c}=he(ye,xe),r=d(!1),h=x=>{r.value=!0,a(x.target.files[0],f=>{console.log(f,"upload.vue::73行")})};return(x,f)=>{const F=N("el-progress"),y=N("el-button"),m=N("el-input-number");return g(),U("div",me,[i("input",{type:"file",onChange:h},null,32),r.value?(g(),U("div",fe,[k(F,{percentage:b(n)},null,8,["percentage"])])):w("",!0),r.value?(g(),U("div",_e,[k(y,{type:"primary",onClick:b(c)},{default:S(()=>[j("全部片段上传")]),_:1},8,["onClick"]),k(y,{type:"primary",onClick:b(p)},{default:S(()=>[j("中断上传")]),_:1},8,["onClick"]),k(y,{type:"primary",onClick:b(c)},{default:S(()=>[j("继续上传")]),_:1},8,["onClick"])])):w("",!0),b(o)?(g(),U("img",{key:2,class:"img",src:b(o)},null,8,ge)):w("",!0),i("div",null,[ke,i("div",Ue,[ve,k(m,{modelValue:t.value,"onUpdate:modelValue":f[0]||(f[0]=u=>t.value=u),min:1,max:8},null,8,["modelValue"])]),i("div",Ce,[be,k(m,{modelValue:s.value,"onUpdate:modelValue":f[1]||(f[1]=u=>s.value=u),min:1,max:8},null,8,["modelValue"])]),k(pe,{imgList:e.value,"onUpdate:imgList":f[2]||(f[2]=u=>e.value=u),concurrentFileNum:t.value,fileConcurrentChunkNum:s.value},null,8,["imgList","concurrentFileNum","fileConcurrentChunkNum"])])])}}}),Oe=I(Fe,[["__scopeId","data-v-fea1ad3a"]]);export{Oe as default};
