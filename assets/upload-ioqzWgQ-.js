import{C as w,a as x}from"./ConcurrentQueen-BWhXleLe.js";import{d as S,h as B,i as D,j as U,c as u,a as d,k as m,l as h,F as I,r as V,w as k,t as _,b as C,e as l,f as $,g,_ as M}from"./index-DXaxPZY2.js";const P={class:"upload"},j={key:0,class:"demo-progress"},z={class:"steps"},R={key:1,class:"upload-all"},A=["src"],r=.4*1024*1024,O=2,Q=S({__name:"upload",setup(E){const p=B(null),e=D({chunkSize:r,file:null,fileName:"",totalChunk:0,finishedChunk:0,chunkPercentage:0,chunkStatus:[],remoteFileUrl:""}),f=U(()=>!!e.totalChunk),y=t=>{const a=t.target.files[0];let n=Math.ceil(a.size/r),o=Array.from({length:n},(c,s)=>({index:s,start:s*r,end:(s+1)*r,status:0}));Object.assign(e,{file:a,totalChunk:n,fileName:a.name,finishedChunk:0,chunkPercentage:0,chunkStatus:o,remoteFileUrl:""})};async function b(t){const a=v(t);let{fileName:n,totalChunk:o}=e;const c=new FormData;c.append("file",a),await x.post(`http://localhost:3000/file/upload?fileName=${n}&currentChunkIndex=${t}&totalChunkNum=${o}`,c).then(s=>{e.finishedChunk+=1,e.chunkPercentage=Math.floor(e.finishedChunk/e.totalChunk*100),e.chunkStatus[t].status=2,s.data.msg==="finished"&&(e.remoteFileUrl=`http://localhost:3000/file/upload-result?fileName=${n}`)})}const v=t=>{const a=p.value.files[0],n=t*r,o=Math.min(n+r,a.size);return a.slice(n,o)},i=new w([],O,async t=>{let{task:a}=t;await b(a.index)}),F=async t=>{i.add(e.chunkStatus[t]),await i.start()};async function N(){for(let t=0;t<e.totalChunk;t++)i.add(e.chunkStatus[t]);await i.start()}return(t,a)=>{const n=C("el-progress"),o=C("el-button");return l(),u("div",P,[d("input",{type:"file",onChange:y,ref_key:"inputRef",ref:p},null,544),f.value?(l(),u("div",j,[m(n,{percentage:e.chunkPercentage},null,8,["percentage"])])):h("",!0),d("div",z,[(l(!0),u(I,null,V(e.totalChunk,(c,s)=>(l(),$(o,{key:s,type:"primary",onClick:L=>F(s)},{default:k(()=>[g(" 上传片段"+_(s+1),1)]),_:2},1032,["onClick"]))),128))]),f.value?(l(),u("div",R,[m(o,{type:"primary",onClick:N},{default:k(()=>[g("全部片段上传")]),_:1})])):h("",!0),e.remoteFileUrl?(l(),u("img",{key:2,class:"img",src:e.remoteFileUrl},null,8,A)):h("",!0),d("div",null,_(e),1)])}}}),G=M(Q,[["__scopeId","data-v-ab35e119"]]);export{G as default};
